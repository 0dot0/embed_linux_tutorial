.. vim: syntax=rst

运行开发板与串口终端登录
------------------------------------------

本章主要讲解如何使用配套的开发板，让开发板的系统运行起来！

了解开发板的启动方式
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

i.MX系列芯片支持多种启动方式，在我们配套的开发板上主要使用其中的NAND-FLASH、eMMC、SD卡及USB启动方式。
通过调整BOOT拨码开关可以设置不同的启动方式。

- Pro 开发板的 ``BOOT开关`` 见 :ref:`EBF6ULL Pro底板硬件资源图` 的上方中间靠左的位置。
- Mini 开发板的 ``BOOT开关`` 见 :ref:`EBF6ULL Mini底板硬件资源图正面` 的左下方位置。

拨码BOOT开关的一侧会写着ON字样，把拨码调至ON一侧表示对应的选项为高电平1，调至另一侧为0，
不同启动方式配置见下表，也可以直接查看开发板上的丝印说明（一般印在板子背面），表中的X表示任意电平均可。

下表为BOOT拨码开关配置的启动方式:


.. table:: BOOT拨码开关启动配置表
   :name: BOOT拨码开关启动配置表

   ==== ====== ========== ==== == ===
   编号 名称   NAND FLASH eMMC SD USB
   ==== ====== ========== ==== == ===
   1    MODE0  0          0    0  1
   2    MODE1  1          1    1  0
   3    CFG1-4 1          0    0  X
   4    CFG1-5 0          1    0  X
   5    CFG1-6 0          1    1  X
   6    CFG1-7 1          0    0  X
   7    CFG2-3 0          1    0  X
   8    CFG2-5 0          0    1  X
   ==== ====== ========== ==== == ===

开发板上电后会根据拨码开关的状态从不同的存储器加载代码运行，故上电前需要根据自己开发板使用的存储器进行配置，
如使用NAND FLASH存储器的开发板，就配置 ``2-3-6`` 至ON档位，即0-1-1-0-0-1-0-0；eMMC存储器启动为 ``2-4-5-7`` 至ON档位；
SD卡启动为 ``2-5-8`` 至ON档位。

其中的USB启动模式主要用来配合NXP官方的mfgtool工具烧录镜像。

硬件准备
~~~~~~~~~~~~~~~~~~~~~~~~

要进行本章的实验操作，需要准备如下硬件：

-  EBF6ULL Mini或Pro开发板

-  **EBF6ULL Mini开发板使用5V电源，EBF6ULL Pro开发板使用DC 12V电源！**

-  USB Mini接口的USB线

-  一台Windows系统的电脑

-  配套的屏幕（可选）

启动步骤
~~~~~~~~~~~~~~~~~~~~~~~~

开发板出厂时默认都烧录了Debian Linux系统，确认根据存储器类型设置了正确的boot启动方式，只要上电就会自动运行。

以下为开发板的启动操作步骤：

1. 根据自己开发板的版本和 BOOT拨码开关启动配置表_ 设置拨码开关（出厂配置通常是配套的，检查确认即可）。

#. 若使用HDMI显示屏，需要在开发板上电前要连接好显示屏。

#. 使用DC电源给开发板供电（Mini开发板使用5V电源，Pro开发板使用DC 12V电源！）。注意由于Pro开发板底板设备较多，功耗大，
   只使用USB线给开发板供电是无法正常运行的！Mini开发板功耗较小，可直接通过USB线接口供电。

#. 按下电源开关，给开发板上电。

#. 若开发板长时间没有反应，长按 **ON/OFF** 按键开机。

#. 对于带屏幕的开发板，可以直接通过触摸屏控制开发板。

#. 开发板支持鼠标和键盘，有需要可以通过USB接口连接至开发板。

#. 对于不带屏幕的开发板，可以通过串口终端控制开发板。关于串口终端的使用请参考下一小节的内容。


.. hint:: 如果供电后直接按电源开关没有反应，可以尝试长按板子的 **ON/OFF** 键进行开机。
   **ON/OFF** 键的功能与PC的开关机键类似，长按可以进行开关机。
   当系统使用 **poweroff** 命令关机后，它是必须长按ON/OFF键才能开机的，这种情况供电后系统不会直接启动，与PC类似。

默认用户名、密码、主机名和IP
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
开发板出厂的Linux系统默认支持使用串口终端以及SSH终端进行控制，
也就是说可以使用串口通讯以及网络通讯的形式，在PC上使用命令行控制开发板。

默认用户名和密码
^^^^^^^^^^^^^^^^

串口终端与SSH终端都使用以下相同的用户名和密码：

普通用户（带sudo权限）：

.. code-block:: sh
   :linenos:

   账户: debian
   密码: temppwd

ROOT用户:

.. code-block:: sh
   :linenos:

   账户: root
   密码: root

若要修改用户名，可以使用 usermod 命令，修改密码可以使用 passwd 命令。

默认主机名和IP
^^^^^^^^^^^^^^^^

使用SSH终端登录时，可以通过主机名和IP连接板子：

.. code-block:: sh
   :linenos:

   主机名: npi 
   IP不固定，默认由路由动态分配，可先通过串口终端连接，使用 ifconfig 命令查看具体IP。

若要修改主机名，修改 /etc/hostname 文件中的内容即可。


串口终端登录
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

默认串口终端参数与驱动
^^^^^^^^^^^^^^^^^^^^^^^^^^

开发板串口终端使用的默认串口通讯参数为： **115200-N-8-1** 。

- Pro 开发板串口终端使用 :ref:`EBF6ULL Pro底板硬件资源图` 中左下方的 ``USB转串口``。它板载了CH340 USB转串口芯片，使用USB线连接即可。
- Mini 开发板的串口终端使用 :ref:`EBF6ULL Mini底板硬件资源图正面` 中右上方的 ``UART TTL接口``。它是直接使用排针引出的TTL电平标准串口，
  推荐使用 `USB转TTL串口线`_ 连接进行通讯。

.. hint:: 使用USB转串口时，都需要先安装对应的驱动。
   Pro 开发板与上面推荐Mini板配套的 `USB转TTL串口线`_ 都使用CH340驱动，驱动下载链接：http://www.wch.cn/products/CH340.html 。


.. _USB转TTL串口线: https://detail.tmall.com/item.htm?spm=a1z10.5-b.w4011-22026361158.32.4b7c7e18f4CE7E&id=600554874281&rn=c55898db719eb30c307b1d2cc23d79b8&abbucket=18


串口终端登录步骤
^^^^^^^^^^^^^^^^^^^^^^^^^^


在Windows下有很多种终端工具，例如MobaXterm、secureCRT、xShell、Putty等，此处我们推荐使用 ``MobaXterm`` 终端软件，
它非常易用且功能强大，对中文支持也好。

下面我们在Windows系统的开发主机使用MobaXterm软件登录串口终端，使用其它系统或工具的方式类似：

1. 安装USB转串口驱动，Pro板载USB转串口和Mini板的 `USB转TTL串口线`_ 都使用CH340驱动，下载地址：http://www.wch.cn/products/CH340.html 。

#. Pro板使用USB线连接电脑与开发板的 ``USB转串口``；Mini板使用 `USB转TTL串口线`_ 连接至开发板的 ``UART TTL接口``。

#. 使用DC电源给开发板供电并开机。Pro板不能只使用USB供电，功率不够。

#. 查看端口号。开发板供电并开机后，在Windows电脑上 ``右键我的电脑->属性->设备管理器的->端口`` ，设备下会新增一个 ``USB-SERIAL CH340`` 设备，
   点开查看自己电脑上该COM口的编号，这在不同的电脑上编号是不同的，如下图所示的本例子为COM4，后面请根据自己的COM号连接。

   .. image:: media/boards003.png
      :align: center


#. 安装MobaXterm软件，在软件官网选择免费版安装即可：https://mobaxterm.mobatek.net/download.html，如下图:

   .. image:: media/boards015.png
      :align: center


#. 打开MobaXterm软件，软件界面如下图所示:

   .. image:: media/boards011.png
      :align: center


   **注意:第一次安装时，左边会话的标签栏是没有任何session的。**

#. 点击菜单栏 「sessions」 --> 「new session」，即可弹出 「session setting」 对话框。
   从会话对话框中可以看到，MobaXterm支持非常多的连接方式，此处我们使用串口连接方式，如下图所示:

   .. image:: media/boards012.png
      :align: center

#. 把MobaXterm的串口的通讯速率配置成开发板串口终端使用的默认值，即 ``115200`` ，
   本例子使用的 端口号为“COM4”， ``注意该端口号要根据自己的实验环境进行选择`` ，
   即在步骤（4）中查看的端口号。如下图:

   .. image:: media/boards013.png
      :align: center

#. 选好串口号及波特率后，点击OK就完成连接了。左边标签栏会记录这次的session，以后可以直接从标签栏打开会话窗口。如下图:

   .. image:: media/boards014.png
      :align: center



#. 如果是在开发板开机前就建立了串口终端连接，那么在开机时会看到开发板在启动时的信息输出，见下图：

   .. image:: media/boards005.png
      :align: center


#. 如果是在开发板开机后才建立的连接，开发板之前的输出没有接收到，这时直接按几下回车即可，见下图：

   .. image:: media/boards006.png
      :align: center

#. 无论是以上哪种情况，开发板的启动流程执行完毕时，只要按回车后终端都会提示login，
   此时终端在等待用户的输入，它需要知道我们希望以哪个用户名登录终端。
   我们的开发板默认用户为：``debian``，密码：``temppwd``。所以在提示界面中输入用户密码并回车登录即可，见下图。

   .. image:: media/boards007.png
      :align: center


#. 至此，我们就成功通过串口登录到开发板的终端了，接下来我们就可以使用各种命令来控制开发板。


#. 按前面的配置，在使用终端软件串口登录，当输入太长的命令时，会出现字符重叠、换行错误的情况，
   非常影响使用感受，这是因为终端软件的换行长度与开发板串口终端长度不一致造成的，
   可在终端软件进行如下配置强制使用相同的换行长度，开发板默认的串口终端行长度为80个字符，
   也可以使用命令“stty size”进行查看。

   .. image:: media/serial_config.png
      :align: center

   注意如果使用的是ssh连接，那么终端与开发板的行长度是自动适应的，如果强制换行长度还会多此一举。


