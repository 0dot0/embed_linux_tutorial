.. vim: syntax=rst

I2C通讯
-----------------

本章通过讲解在应用层中使用I2C总线与外部设备的通讯，讲解Linux系统总线类型设备驱动架构的应用。

在Linux内核文档的Documentation/i2c目录下有关于I2C驱动非常详细的说明。

本章节的示例代码目录为：base_code/section2/i2c

I2C通讯协议简介
^^^^^^^^^^^^^^^^^^^^^

I2C 通讯协议(Inter－Integrated Circuit)是由Phiilps公司开发的，
由于它引脚少，硬件实现简单，可扩展性强，不需要USART、CAN等通讯协议的外部收发设备，
被广泛地使用在多个集成电路(IC)间的通讯。

下面我们分别对I2C协议的物理层及协议层进行讲解。

I2C物理层
~~~~~~~~~~~~~~~~~~~~~~~~

I2C通讯设备之间的常用连接方式如下图。

.. image:: media/i2c/i2cbus002.png
   :align: center
   :alt: 常见的I2C通讯系统


它的物理层有如下特点：

- 它是一个支持多设备的总线。“总线”指多个设备共用的信号线。
  在一个I2C通讯总线中，可连接多个I2C通讯设备，支持多个通讯主机及多个通讯从机。
- 一个I2C总线只使用两条总线线路，一条双向串行数据线(SDA) ，一条串行时钟线 (SCL)。
  数据线即用来表示数据，时钟线用于数据收发同步。
- 每个连接到总线的设备都有一个独立的设备地址，主机可以利用这个地址进行不同设备之间的访问。
  其中地址是一个七位或十位的数字。
- 总线通过上拉电阻接到电源。当I2C设备空闲时，会输出高阻态，而当所有设备都空闲，
  都输出高阻态时，由上拉电阻把总线拉成高电平。
- 多个主机同时使用总线时，为了防止数据冲突，会利用仲裁方式决定由哪个设备占用总线。
- 具有三种传输模式：标准模式传输速率为100kbit/s ，快速模式为400kbit/s ，
  高速模式下可达 3.4Mbit/s，但目前大多I2C设备尚不支持高速模式。
- 连接到相同总线的 IC 数量受到总线的最大电容 400pF 限制 。

协议层
~~~~~~~~~~~~~~~~~~~~~

I2C的协议定义了通讯的起始和停止信号、数据有效性、响应、仲裁、时钟同步和地址广播等环节。

I2C基本读写过程
"""""""""""""""""""

先看看I2C通讯过程的基本结构，它的通讯过程常有如下三种方式。

.. image:: media/i2c/i2cbus003.jpg
   :align: center
   :alt: 主机写数据到从机

.. image:: media/i2c/i2cbus004.jpg
   :align: center
   :alt: 主机由从机中读数据

.. image:: media/i2c/i2cbus005.jpeg
   :align: center
   :alt: I2C通讯复合格式

图例：

- |i2cbus006| ：数据由主机传输至从机

- S ： 传输开始信号

- SLAVE_ADDRESS: 从机地址

- |i2cbus007| ：数据由从机传输至主机

- R ： 传输方向选择位，1为读，0为写

- A ： 应答(ACK)或非应答(NACK)信号

- P ： 停止传输信号

这些图表示的是主机和从机通讯时，SDA线的数据包序列。

1. 其中S表示由主机的I2C接口产生的传输起始信号(S)，这时连接到I2C总线上的所有从机都会接收到这个信号。

#. 起始信号产生后，所有从机就开始等待主机紧接下来广播 的从机地址信号 (SLAVE_ADDRESS)。
   在I2C总线上，每个设备的地址都是唯一的，当主机广播的地址与某个设备地址相同时，这个设备就被选中了，没被选中的设备将会忽略之后的数据信号。
   根据I2C协议，这个从机地址可以是7位或10位。

#. 在地址位之后，是传输方向的选择位，该位为0时，表示后面的数据传输方向是由主机传输至从机，即主机向从机写数据。该位为1时，则相反，即主机由从机读数据。

#. 从机接收到匹配的地址后，主机或从机会返回一个应答(ACK)或非应答(NACK)信号，只有接收到应答信号后，主机才能继续发送或接收数据。


写数据方向:
  若配置的方向传输位为 **“写数据”** 方向，即第一幅图的情况，广播完地址，接收到应答信号后，
  主机开始正式向从机 **传输数据(DATA)** ，数据包的大小为8位，主机每发送完一个字节数据，
  都要等待从机的应答信号(ACK)，重复这个过程，可以向从机传输N个数据，这个N没有大小限制。
  当数据传输结束时，主机向从机发送一个停止传输信号(P)，表示不再传输数据。

读数据方向:
  若配置的方向传输位为 **“读数据”** 方向，即第二幅图的情况，广播完地址，接收到应答信号后，
  从机开始向主机 **返回数据(DATA)** ，数据包大小也为8位，从机每发送完一个数据，
  都会等待主机的应答信号(ACK)，重复这个过程，可以返回N个数据，这个N也没有大小限制。
  当主机希望停止接收数据时，就向从机返回一个非应答信号(NACK)，则从机自动停止数据传输。

复合格式:
  除了基本的读写，I2C通讯更常用的是 **复合格式** ，即第三幅图的情况，该传输过程有 **两次起始信号(S)** 。
  一般在第一次传输中，主机通过SLAVE_ADDRESS寻找到从设备后，发送一段“数据”，
  这段数据通常用于表示从设备内部的寄存器或存储器地址(注意区分它与SLAVE_ADDRESS的区别)；
  在第二次的传输中，对该地址的内容进行读或写。也就是说，第一次通讯是告诉从机读写地址，第二次则是读写的实际内容。

以上通讯流程中包含的起始、停止、数据有效性、地址和数据方向以及响应的说明按小节如下。


通讯的起始和停止信号
"""""""""""""""""""""""""""

前文中提到的起始(S)和停止(P)信号是两种特殊的状态，起始和停止信号一般由主机产生。如下图。

- 当 SCL 线是高电平时 SDA 线从高电平向低电平切换，这个情况表示通讯的起始。
- 当 SCL 是高电平时 SDA 线由低电平向高电平切换，表示通讯的停止。

.. image:: media/i2c/i2cbus008.jpg
   :align: center
   :alt: 起始和停止信号


数据有效性
"""""""""""""""""""""""""""

I2C使用SDA信号线来传输数据，使用SCL信号线进行数据同步，如下图。
SDA数据线在SCL的每个时钟周期传输一位数据。

- 传输时，SCL为高电平的时候SDA表示的数据有效，即此时的SDA为高电平时表示数据“1”，为低电平时表示数据“0”。
- 当SCL为低电平时，SDA的数据无效，一般在这个时候SDA进行电平切换，为下一次表示数据做好准备。

.. image:: media/i2c/i2cbus009.jpg
   :align: center
   :alt: 数据有效性

每次数据传输都以字节为单位，每次传输的字节数不受限制。

地址及数据方向
""""""""""""""""""""""""

I2C总线上的每个设备都有自己的独立地址，主机发起通讯时，通过SDA信号线发送设备地址(SLAVE_ADDRESS)来查找从机。
I2C协议规定设备地址可以是7位或10位，实际中7位的地址应用比较广泛。

紧跟设备地址的一个数据位用来表示数据传输方向，它是数据方向位(R/)，第8位或第11位。
数据方向位为“1”时表示主机由从机读数据，该位为“0”时表示主机向从机写数据，如下图。

.. image:: media/i2c/i2cbus010.jpg
   :align: center
   :alt: 设备地址(7位)及数据传输方向


- 读数据方向时，主机会释放对SDA信号线的控制，由从机控制SDA信号线，主机接收信号。
- 写数据方向时，SDA由主机控制，从机接收信号。

响应
""""""""""""""""""""

I2C的数据和地址传输都带响应。响应包括“应答(ACK)”和“非应答(NACK)”两种信号。
作为数据接收端时，当设备(无论主从机)接收到I2C传输的一个字节数据或地址后：

- 若希望对方 **继续发送数据** ，则需要向对方发送 **“应答(ACK)”** 信号，发送方会继续发送下一个数据；
- 若接收端希望 **结束数据传输** ，则向对方发送 **“非应答(NACK)”** 信号，发送方接收到该信号后会产生一个停止信号，结束信号传输。如下图。

.. image:: media/i2c/i2cbus011.jpg
   :align: center
   :alt: 响应与非响应信号


传输时主机产生时钟，在第9个时钟时，数据发送端会释放SDA的控制权，由数据接收端控制SDA，若SDA为高电平，表示非应答信号(NACK)，低电平表示应答信号(ACK)。




i2c-detect工具
^^^^^^^^^^^^^^^^^^^^^





读取陀螺仪传感器数据
^^^^^^^^^^^^^^^^^^^^^


控制OLED显示
^^^^^^^^^^^^^^^^^^^^^






.. |i2cbus002| image:: media/i2c/i2cbus002.png
   :width: 5.8812in
   :height: 2.17074in
.. |i2cbus003| image:: media/i2c/i2cbus003.jpg
   :width: 5.34375in
   :height: 1.02083in
.. |i2cbus004| image:: media/i2c/i2cbus004.jpg
   :width: 5.26042in
   :height: 1.20833in
.. |i2cbus005| image:: media/i2c/i2cbus005.jpeg
   :width: 5.44707in
   :height: 1.14179in
.. |i2cbus006| image:: media/i2c/i2cbus006.png
   :width: 0.23958in
   :height: 0.23958in
.. |i2cbus007| image:: media/i2c/i2cbus007.png
   :width: 0.25in
   :height: 0.25in
.. |i2cbus008| image:: media/i2c/i2cbus008.jpg
   :width: 5.54668in
   :height: 1.54478in
.. |i2cbus009| image:: media/i2c/i2cbus009.jpg
   :width: 3.90898in
   :height: 1.98576in
.. |i2cbus010| image:: media/i2c/i2cbus010.jpg
   :width: 5.76806in
   :height: 1.67222in
.. |i2cbus011| image:: media/i2c/i2cbus011.jpg
   :width: 5.78538in
   :height: 2.74747in
